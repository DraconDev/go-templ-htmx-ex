package pages

//go:generate templ generate
templ AuthCallbackContent() {
	<div class="max-w-2xl mx-auto text-center">
		<div class="glass-card rounded-lg shadow-2xl p-8">
			<div class="mb-6">
				<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-500 mx-auto glow-effect"></div>
			</div>
			<h2 class="text-2xl font-bold text-white mb-4">Setting up your session...</h2>
			<p id="auth-message" class="text-gray-300 mb-6">Please wait while we authenticate you...</p>
			<div id="error-message" class="hidden text-red-400 bg-red-900/50 border border-red-400/50 px-4 py-3 rounded mb-4"></div>
			<div id="success-message" class="hidden text-green-400 bg-green-900/50 border border-green-400/50 px-4 py-3 rounded mb-4"></div>
		</div>
	</div>
	<script>
		// Function to get provider name from URL or code format
		function getProviderName() {
			var urlParams = new URLSearchParams(window.location.search);
			var code = urlParams.get('code');
			
			if (code) {
				if (code.startsWith('discord_')) {
					return 'Discord';
				} else if (code.startsWith('gh_') || code.startsWith('github_')) {
					return 'GitHub';
				} else if (code.startsWith('google_') || code.includes('.')) {
					return 'Google';
				} else if (code.startsWith('ms_') || code.startsWith('microsoft_')) {
					return 'Microsoft';
				}
			}
			
			// Fallback: check URL path
			var path = window.location.pathname;
			if (path.includes('discord')) return 'Discord';
			if (path.includes('github')) return 'GitHub';
			if (path.includes('google')) return 'Google';
			if (path.includes('microsoft')) return 'Microsoft';
			
			return 'your provider';
		}
		
		// Function to parse URL parameters (query string)
		function parseParameters() {
			var search = window.location.search.substring(1); // Remove ?
			var fragment = window.location.hash.substring(1); // Remove #
			var params = {};
			
			console.log('üîç PARSE: Full URL:', window.location.href);
			console.log('üîç PARSE: Search params:', search);
			console.log('üîç PARSE: Hash fragment:', fragment);
			
			// Parse query parameters first (OAuth code comes here)
			if (search) {
				var pairs = search.split('&');
				for (var i = 0; i < pairs.length; i++) {
					var pair = pairs[i].split('=');
					if (pair.length === 2) {
						params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
					}
				}
			}
			
			// Also parse hash fragment (for backward compatibility)
			if (fragment) {
				var hashPairs = fragment.split('&');
				for (var j = 0; j < hashPairs.length; j++) {
					var hashPair = hashPairs[j].split('=');
					if (hashPair.length === 2) {
						params[decodeURIComponent(hashPair[0])] = decodeURIComponent(hashPair[1]);
					}
				}
			}
			
			console.log('üîç PARSE: All parsed parameters:', params);
			return params;
		}

		// Function to set session and redirect
		function setSessionAndRedirect() {
			console.log('üîê CALLBACK: === CALLBACK FUNCTION STARTED ===');
			
			var params = parseParameters();
			console.log('üîê CALLBACK: Parsed parameters:', params);
			
			// Update message with provider name
			var providerName = getProviderName();
			var messageElement = document.getElementById('auth-message');
			messageElement.textContent = 'Please wait while we authenticate you with ' + providerName + '.';
			console.log('üîê CALLBACK: Provider detected:', providerName);
			
			// Check for OAuth auth_code in URL (auth service sends auth_code, not code)
			var code = params['auth_code'];
			console.log('üîê CALLBACK: Auth code from params:', code);
			
			if (!code) {
				console.error('üîê CALLBACK: No authorization code found in URL params');
				showError('No authorization code found in URL. Please try logging in again.');
				return;
			}
			
			console.log('üîê CALLBACK: Authorization code received, length:', code.length);
			console.log('üîê CALLBACK: Code preview:', code.substring(0, 20) + '...');

			console.log('üîê CALLBACK: === ABOUT TO MAKE AUTH SERVICE CALL ===');
			
			// Step 1: Call auth service to get session_id
			fetch('http://localhost:8080/auth/session/create', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					auth_code: code
				})
			})
			.then(response => {
				console.log('üîê CALLBACK: === AUTH SERVICE RESPONSE RECEIVED ===');
				console.log('üîê CALLBACK: Auth service response status:', response.status);
				console.log('üîê CALLBACK: Response ok:', response.ok);
				if (!response.ok) {
					throw new Error('Auth service returned error: ' + response.status);
				}
				return response.json();
			})
			.then(authData => {
				console.log('üîê CALLBACK: === AUTH SERVICE SUCCESS ===');
				console.log('üîê CALLBACK: Auth service response:', authData);
				
				var sessionId = authData.session_id;
				if (!sessionId) {
					throw new Error('No session_id received from auth service');
				}
				
				console.log('üîê CALLBACK: Session ID received:', sessionId);
				
				// Step 2: Call main app to set session cookie
				return fetch('/api/auth/set-session', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						session_id: sessionId
					})
				})
				.then(setSessionResponse => {
					console.log('üîê CALLBACK: === SET SESSION RESPONSE ===');
					console.log('üîê CALLBACK: Set session response status:', setSessionResponse.status);
					console.log('üîê CALLBACK: Set session response ok:', setSessionResponse.ok);
					if (!setSessionResponse.ok) {
						throw new Error('Failed to set session: ' + setSessionResponse.status);
					}
					return setSessionResponse.json();
				})
				.then(setSessionData => {
					console.log('üîê CALLBACK: === SESSION SET SUCCESS ===');
					console.log('üîê CALLBACK: Set session response:', setSessionData);
					showSuccess('Authentication successful! Redirecting to home...');
					setTimeout(() => {
						window.location.href = '/';
					}, 1500);
				});
			})
			.catch(error => {
				console.error('üîê CALLBACK: === FETCH ERROR ===');
				console.error('üîê CALLBACK: Error details:', error);
				console.error('üîê CALLBACK: Error message:', error.message);
				console.error('üîê CALLBACK: Error stack:', error.stack);
				showError('Error: ' + error.message);
			});
				
			console.log('üîê CALLBACK: === ASYNC CALLS INITIATED ===');
		}

		function showError(message) {
			var errorDiv = document.getElementById('error-message');
			errorDiv.textContent = message;
			errorDiv.classList.remove('hidden');
		}

		function showSuccess(message) {
			var successDiv = document.getElementById('success-message');
			successDiv.textContent = message;
			successDiv.classList.remove('hidden');
		}

		// Run when page loads
		setSessionAndRedirect();
	</script>
}
